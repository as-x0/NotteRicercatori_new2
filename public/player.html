<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FAOSTAT Game - Player</title>
</head>
<body>
  <h1>Player</h1>

  <!-- Sezione Join -->
  <div id="joinSection">
    <label>Nome:</label>
    <input type="text" id="playerName">
    <label>Room ID:</label>
    <input type="text" id="roomIdInput">
    <button id="joinBtn">Entra</button>
  </div>

  <!-- Sezione Gioco -->
  <div id="gameSection" style="display:none;">
    <h3>Scegli i tuoi paesi</h3>
    <form id="countriesForm"></form>
    <button id="submitCountriesBtn">Conferma scelte</button>
  </div>

  <!-- Sezione Risultati -->
  <div id="resultsSection" style="display:none;">
    <h3>Risultati</h3>
    <ul id="resultsList"></ul>
    <canvas id="resultsChart"></canvas>
    <button onclick="window.location.reload()">Torna alla Home</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const socket = io();

    const joinBtn = document.getElementById("joinBtn");
    const playerNameInput = document.getElementById("playerName");
    const roomIdInput = document.getElementById("roomIdInput");
    const joinSection = document.getElementById("joinSection");

    const gameSection = document.getElementById("gameSection");
    const countriesForm = document.getElementById("countriesForm");
    const submitCountriesBtn = document.getElementById("submitCountriesBtn");

    const resultsSection = document.getElementById("resultsSection");
    const resultsList = document.getElementById("resultsList");

    let currentRoomId = null;
    let numCountries = 3;
    let countryList = [];

    // Entra nella stanza
    joinBtn.addEventListener("click", () => {
      const name = playerNameInput.value.trim();
      const roomId = roomIdInput.value.trim();
      if (!name || !roomId) return alert("Inserisci nome e Room ID!");
      currentRoomId = roomId;
      socket.emit("joinRoom", { roomId, name });
      joinSection.style.display = "none";
    });

    // Avvio gioco dal manager
    socket.on("gameStarted", (settings) => {
      numCountries = settings.numCountries;
      gameSection.style.display = "block";

      // Richiesta lista paesi
      socket.emit("requestCountries");
    });

    // Ricezione lista paesi
    socket.on("countryList", (countries) => {
      countryList = countries;
      renderCountryInputs();
    });

    // Funzione per creare campi input con autocompletamento
    function renderCountryInputs() {
      countriesForm.innerHTML = "";

      // Datalist per autocompletamento
      let dataList = document.getElementById("countriesDatalist");
      if (dataList) dataList.remove();
      dataList = document.createElement("datalist");
      dataList.id = "countriesDatalist";
      dataList.innerHTML = countryList.map(c => `<option value="${c}">`).join("");
      document.body.appendChild(dataList);

      for (let i = 0; i < numCountries; i++) {
        const input = document.createElement("input");
        input.setAttribute("list", "countriesDatalist");
        input.name = "country";
        input.placeholder = `Paese ${i+1}`;
        countriesForm.appendChild(input);
        countriesForm.appendChild(document.createElement("br"));
      }
    }

    // Invio scelte paesi al server
    submitCountriesBtn.addEventListener("click", () => {
      const inputs = countriesForm.querySelectorAll("input[name='country']");
      const chosen = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
      if (chosen.length !== numCountries) {
        return alert(`Devi scegliere esattamente ${numCountries} paesi`);
      }
      socket.emit("chooseCountries", { roomId: currentRoomId, countries: chosen });
      gameSection.style.display = "none";
    });

    // Ricezione risultati
    socket.on("gameEnded", ({ players, topCountries }) => {
      resultsSection.style.display = "block";
      resultsList.innerHTML = players.map(p => `<li>${p.name}: ${p.score}</li>`).join("");

      const ctx = document.getElementById("resultsChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: topCountries.map(c => c.Country),
          datasets: [{
            label: "Esportazioni",
            data: topCountries.map(c => c.Value)
          }]
        }
      });
    });

    // Errori
    socket.on("errorMsg", (msg) => alert(msg));
  </script>
</body>
</html>

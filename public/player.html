<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="joinSection">
    <h2>Player</h2>
    <label>Nome:</label>
    <input type="text" id="playerName">
    <label>Room ID:</label>
    <input type="text" id="roomIdInput">
    <button id="joinBtn">Entra</button>
  </div>

  <!-- Sezione scelta paesi -->
  <div id="gameSection" style="display:none;">
    <h3>Scegli i tuoi paesi</h3>
    <form id="countriesForm"></form>
    <button id="submitCountries">Conferma scelte</button>
  </div>

  <!-- Risultati -->
  <div id="resultsSection" style="display:none;">
    <h3>Risultati</h3>
    <ul id="resultsList"></ul>
    <canvas id="resultsChart"></canvas>
    <button onclick="window.location.reload()">Torna alla Home</button>
  </div>

<script>
  const socket = io();
  const joinBtn = document.getElementById("joinBtn");
  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const gameSection = document.getElementById("gameSection");
  const countriesForm = document.getElementById("countriesForm");
  const submitCountriesBtn = document.getElementById("submitCountries");
  const resultsSection = document.getElementById("resultsSection");
  const resultsList = document.getElementById("resultsList");

  let currentRoomId = null;
  let numCountries = 3;
  let countryList = [];

  // Entrata del giocatore
  joinBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    const roomId = roomIdInput.value.trim();
    if (!name || !roomId) return alert("Inserisci nome e Room ID");
    currentRoomId = roomId;
    socket.emit("joinRoom", { roomId, name });
  });

  // Ricezione impostazioni dal manager
  socket.on("gameStarted", (settings) => {
    numCountries = settings.numCountries;
    gameSection.style.display = "block";
    socket.emit("requestCountries");
  });

  // Riceviamo lista paesi dal server
  socket.on("countryList", (countries) => {
    countryList = countries;
    renderCountryInputs();
  });

  // Render input con datalist
  function renderCountryInputs() {
    countriesForm.innerHTML = "";
    for (let i = 0; i < numCountries; i++) {
      const input = document.createElement("input");
      input.setAttribute("list", "countries");
      input.name = "country";
      input.placeholder = "Inserisci un Paese";
      countriesForm.appendChild(input);
      countriesForm.appendChild(document.createElement("br"));
    }

    let dataList = document.getElementById("countries");
    if (dataList) dataList.remove();
    dataList = document.createElement("datalist");
    dataList.id = "countries";
    dataList.innerHTML = countryList.map(c => `<option value="${c}">`).join("");
    document.body.appendChild(dataList);
  }

  // Invio scelte al server
  submitCountriesBtn.addEventListener("click", () => {
    const inputs = countriesForm.querySelectorAll("input[name='country']");
    const chosen = [...inputs].map(i => i.value.trim()).filter(Boolean);
    if (chosen.length !== numCountries) {
      alert(`Devi scegliere esattamente ${numCountries} paesi`);
      return;
    }
    socket.emit("chooseCountries", { roomId: currentRoomId, countries: chosen });
    gameSection.style.display = "none";
  });

  // Risultati finali
  socket.on("gameEnded", ({ players, topCountries }) => {
    resultsSection.style.display = "block";
    resultsList.innerHTML = players.map(p => `<li>${p.name}: ${p.score}</li>`).join("");

    // Disegno grafico top 5 paesi
    const ctx = document.getElementById("resultsChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: topCountries.map(c => c.Country),
        datasets: [{
          label: "Esportazioni",
          data: topCountries.map(c => c.Value)
        }]
      }
    });
  });

  // Messaggi di errore
  socket.on("errorMsg", (msg) => {
    alert(msg);
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player FAOSTAT Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h3 { color: #2c3e50; }
    button { margin: 5px 0; padding: 5px 10px; }
    input { margin: 3px 0; padding: 5px; width: 200px; }
    #resultsList li { margin-bottom: 3px; }
  </style>
</head>
<body>
<h1>Player</h1>

<!-- Sezione join stanza -->
<div id="joinSection">
  <label>Nome: <input type="text" id="playerName"></label><br>
  <label>Room ID: <input type="text" id="roomIdInput"></label><br>
  <button id="joinRoomBtn">Entra</button>
</div>

<!-- Sezione gioco -->
<div id="gameArea" style="display:none;">
  <h3 id="gameTitle">Scegli i Paesi</h3>
  <form id="countriesForm"></form>
  <button id="submitCountriesBtn">Invia Scelte</button>
</div>

<!-- Sezione risultati -->
<div id="resultsArea" style="display:none;">
  <h3>Risultati</h3>
  <ul id="resultsList"></ul>
  <canvas id="resultsChart"></canvas>
  <br>
  <button id="homeBtn">Torna alla Home</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();

  // Elementi DOM
  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const gameArea = document.getElementById("gameArea");
  const gameTitle = document.getElementById("gameTitle");
  const countriesForm = document.getElementById("countriesForm");
  const submitCountriesBtn = document.getElementById("submitCountriesBtn");
  const resultsArea = document.getElementById("resultsArea");
  const resultsList = document.getElementById("resultsList");
  const resultsChart = document.getElementById("resultsChart");
  const homeBtn = document.getElementById("homeBtn");

  let currentRoomId = null;
  let numCountries = 0;
  let availableCountries = [];
  let currentProduct = "";

  // Join stanza
  joinRoomBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    const roomId = roomIdInput.value.trim();
    if (!name || !roomId) return alert("Inserisci nome e Room ID!");
    currentRoomId = roomId;
    socket.emit("joinRoom", { roomId, name });
  });

  // Riceve impostazioni dal manager
  socket.on("settingsUpdated", (settings) => {
    numCountries = settings.numCountries;
    currentProduct = settings.product;
  });

  // Riceve lista dei Paesi disponibili
  socket.on("countriesList", ({ countries, settings }) => {
    availableCountries = countries;
    numCountries = settings.numCountries;
    currentProduct = settings.product;

    // Mostra area gioco
    gameArea.style.display = "block";

    // Aggiorna titolo dinamico
    gameTitle.textContent = `Scegli i maggiori esportatori di ${currentProduct} del 2023`;

    // Pulisce form
    countriesForm.innerHTML = "";

    // Crea campi input dinamici
    for (let i = 0; i < numCountries; i++) {
      const input = document.createElement("input");
      input.setAttribute("list", "countriesDatalist");
      input.placeholder = `Paese ${i+1}`;
      input.required = true;
      countriesForm.appendChild(input);
      countriesForm.appendChild(document.createElement("br"));
    }

    // Datalist per autocompletamento
    let datalist = document.getElementById("countriesDatalist");
    if (!datalist) {
      datalist = document.createElement("datalist");
      datalist.id = "countriesDatalist";
      document.body.appendChild(datalist);
    }
    datalist.innerHTML = countries.map(c => `<option value="${c}">`).join("");
  });

  // Invio Paesi scelti
  submitCountriesBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const selectedCountries = Array.from(countriesForm.querySelectorAll("input"))
                                  .map(i => i.value.trim())
                                  .filter(Boolean);
    if (selectedCountries.length !== numCountries) {
      return alert(`Devi scegliere esattamente ${numCountries} Paesi!`);
    }
    selectedCountries.forEach(c => {
      socket.emit("selectCountry", { roomId: currentRoomId, country: c });
    });
    alert("Scelte inviate!");
  });

  // Riceve risultati e crea grafico
  socket.on("gameEnded", ({ players, topCountries, settings }) => {
    gameArea.style.display = "none";
    resultsArea.style.display = "block";

    resultsList.innerHTML = players
      .map(p => `<li>${p.name}: ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`)
      .join("");

    const ctx = resultsChart.getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: topCountries.map(c => c.Country),
        datasets: [{
          label: `Esportazioni ${settings.product} 2023`,
          data: topCountries.map(c => c.Value),
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: `Totale mondiale: ${settings.totalWorld?.toLocaleString() || "?"} t` } },
        scales: { y: { beginAtZero: true } }
      }
    });
  });

  socket.on("errorMsg", (msg) => alert(msg));

  homeBtn.addEventListener("click", () => {
    window.location.reload();
  });
});
</script>
</body>
</html>

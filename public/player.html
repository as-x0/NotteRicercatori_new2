<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player FAOSTAT Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h3 { color: #2c3e50; }
    button { margin: 5px 0; padding: 5px 10px; }
    input { margin: 3px 0; padding: 5px; width: 200px; }
    #countriesForm input { display: block; }
  </style>
</head>
<body>
<h1>Player</h1>

<div id="joinSection">
  <label>Nome: <input type="text" id="playerName"></label><br>
  <label>Room ID: <input type="text" id="roomIdInput"></label><br>
  <button id="joinRoomBtn">Entra</button>
</div>

<div id="gameArea" style="display:none;">
  <h3 id="chooseCountriesHeader">Scegli i Paesi</h3>
  <form id="countriesForm"></form>
  <button id="submitCountriesBtn">Invia Scelte</button>
</div>

<div id="resultsArea" style="display:none;">
  <h3>Risultati</h3>
  <ul id="resultsList"></ul>
  <br>
  <button id="homeBtn">Torna alla Home</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();

  const playerNameInput = document.getElementById("playerName");
  const roomIdInput = document.getElementById("roomIdInput");
  const joinRoomBtn = document.getElementById("joinRoomBtn");

  const gameArea = document.getElementById("gameArea");
  const countriesForm = document.getElementById("countriesForm");
  const submitCountriesBtn = document.getElementById("submitCountriesBtn");

  const chooseCountriesHeader = document.getElementById("chooseCountriesHeader");

  const resultsArea = document.getElementById("resultsArea");
  const resultsList = document.getElementById("resultsList");
  const homeBtn = document.getElementById("homeBtn");

  let currentRoomId = null;
  let numCountries = 0;
  let availableCountries = [];

  // Quando ricevi le impostazioni dal manager
  socket.on("settingsUpdated", (settings) => {
    numCountries = settings.numCountries;
    chooseCountriesHeader.textContent = `Scegli i maggiori esportatori di ${settings.product.toLowerCase()} nel ${settings.year}`;
  });

  joinRoomBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    const roomId = roomIdInput.value.trim();
    if (!name || !roomId) return alert("Inserisci nome e Room ID!");
    currentRoomId = roomId;
    socket.emit("joinRoom", { roomId, name });
    joinRoomBtn.disabled = true;
    alert(`Sei entrato nella stanza ${roomId} come ${name}!  Attendi che la partita venga avviata...`)
  });

  socket.on("settingsUpdated", (settings) => {
    numCountries = settings.numCountries;
  });

  socket.on("countriesList", (countries) => {
    availableCountries = countries;
    gameArea.style.display = "block";
    countriesForm.innerHTML = "";

    let datalist = document.getElementById("countriesDatalist");
    if (!datalist) {
      datalist = document.createElement("datalist");
      datalist.id = "countriesDatalist";
      document.body.appendChild(datalist);
    }
    datalist.innerHTML = countries.map(c => `<option value="${c}">`).join("");

    for (let i = 0; i < numCountries; i++) {
      const input = document.createElement("input");
      input.setAttribute("list", "countriesDatalist");
      input.placeholder = `Paese ${i+1}`;
      input.required = true;
      countriesForm.appendChild(input);
    }
  });

  submitCountriesBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const selectedCountries = Array.from(countriesForm.querySelectorAll("input"))
                                  .map(i => i.value.trim())
                                  .filter(Boolean);
    if (selectedCountries.length !== numCountries) {
      return alert(`Devi scegliere esattamente ${numCountries} Paesi!`);
    }
    selectedCountries.forEach(c => {
      socket.emit("selectCountry", { roomId: currentRoomId, country: c });
    });
    alert("Scelte inviate!");
    submitCountriesBtn.disabled = true;
  });

  // ✅ Fine partita
  socket.on("gameEnded", ({ leaderboard }) => {
    gameArea.style.display = "none";
    resultsArea.style.display = "block";

    resultsList.innerHTML = leaderboard
      .map((p, i) => `<li>${i + 1}. <strong>${p.name}</strong> → ${p.score.toLocaleString()} t (${p.percentage.toFixed(2)}%)</li>`)
      .join("");
  });

  socket.on("errorMsg", (msg) => alert(msg));

  homeBtn.addEventListener("click", () => {
    window.location.reload();
  });
});
</script>
</body>
</html>

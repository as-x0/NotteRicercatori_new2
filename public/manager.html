<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>FAOSTAT Game - Manager</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; padding:20px; }
    h1 { color:#1e3a8a; }
    button { background:#2563eb; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin:5px; }
    button:hover { background:#1d4ed8; }
    select, input { padding:5px; margin:5px; border-radius:6px; }
    #results { margin-top:20px; }
    canvas { max-width:600px; margin-top:20px; }
  </style>
</head>
<body>
  <h1>Manager</h1>
  <button id="createRoom">Crea stanza</button>
  <div id="roomInfo" style="display:none;">
    <p>ID Stanza: <span id="roomId"></span></p>
    <h3>Impostazioni gioco</h3>
    <label>Prodotto: <select id="productSelect"></select></label><br>
    <p><b>Anno: 2023</b></p>
    <p>Numero Paesi:</p>
    <label><input type="radio" name="numCountries" value="3" checked> 3</label>
    <label><input type="radio" name="numCountries" value="5"> 5</label><br>

    <button id="saveSettings">Salva impostazioni</button>
    <button id="startGame">Avvia Gioco</button>
    <button id="endGame" style="display:none; background:#dc2626;">Termina Gioco</button>

    <h3>Giocatori</h3>
    <ul id="playerList"></ul>
  </div>

  <h3>Risultati</h3>
  <div id="results"></div>
  <canvas id="chart"></canvas>
  <button id="backHome" style="display:none;">Torna alla Home Manager</button>

  <script>
    const socket = io();

    const createBtn = document.getElementById("createRoom");
    const roomInfo = document.getElementById("roomInfo");
    const roomIdSpan = document.getElementById("roomId");
    const productSelect = document.getElementById("productSelect");
    const saveBtn = document.getElementById("saveSettings");
    const startBtn = document.getElementById("startGame");
    const endBtn = document.getElementById("endGame");
    const playerList = document.getElementById("playerList");
    const resultsDiv = document.getElementById("results");
    const backHome = document.getElementById("backHome");
    let chartInstance = null;
    let currentRoomId = null;

    createBtn.onclick = () => socket.emit("createRoom");

    saveBtn.onclick = () => {
      const numCountries = parseInt(document.querySelector("input[name='numCountries']:checked").value);
      socket.emit("setSettings", { roomId: currentRoomId, product: productSelect.value, numCountries });
    };

    startBtn.onclick = () => {
      socket.emit("startGame", currentRoomId);
      endBtn.style.display = "inline-block";
    };

    endBtn.onclick = () => socket.emit("endGame", currentRoomId);

    backHome.onclick = () => window.location.href = "/index.html";

    socket.on("roomCreated", ({ roomId, products }) => {
      currentRoomId = roomId;
      roomIdSpan.textContent = roomId;
      roomInfo.style.display = "block";
      productSelect.innerHTML = products.map(p => `<option>${p}</option>`).join("");
    });

    socket.on("playerList", (players) => {
      playerList.innerHTML = players.map(p => `<li>${p.name} - Paesi scelti: ${p.countries.join(", ") || "Nessuno"}</li>`).join("");
    });

    socket.on("gameEnded", ({ leaderboard, top5, product }) => {
      resultsDiv.innerHTML = "<h4>Classifica:</h4>" +
        leaderboard.map(p => `<div>${p.name} - ${p.score} punti</div>`).join("");
      backHome.style.display = "inline-block";

      // Mostra grafico top5 paesi esportatori
      const labels = top5.map(t => t.country);
      const values = top5.map(t => t.value);

      if(chartInstance) chartInstance.destroy();
      const ctx = document.getElementById("chart").getContext("2d");
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: `Export ${product} (2023)`, data: values }] },
        options: { responsive:true, plugins:{ legend:{ display:false } } }
      });
    });
  </script>
</body>
</html>
